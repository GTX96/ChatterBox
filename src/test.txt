
# registro un po' di nickname
./client -l "/tmp/chatty_socket" -c pippo &
./client -l "/tmp/chatty_socket" -c pluto &
./client -l "/tmp/chatty_socket" -c minni &
./client -l "/tmp/chatty_socket" -c topolino &
./client -l "/tmp/chatty_socket" -c paperino &
./client -l "/tmp/chatty_socket" -c qui &
./client -l "/tmp/chatty_socket" -c quo &
./client -l "/tmp/chatty_socket" -c qua &
wait

# minni deve ricevere 8 messaggi prima di terminare
./client -l "/tmp/chatty_socket" -k minni -R 8 &
pid=$!

# aspetto un po' per essere sicuro che il client sia partito
sleep 1

# primo messaggio
./client -l "/tmp/chatty_socket" -k topolino -S "ciao da topolino":minni
if [[ $? != 0 ]]; then
    exit 1
fi
# secondo e terzo
./client -l "/tmp/chatty_socket" -k paperino -S "ciao da paperino":minni -S "ciao ciao!!!":minni
if [[ $? != 0 ]]; then
    exit 1
fi
# quarto
./client -l "/tmp/chatty_socket" -k qui -S "ciao a tutti":
if [[ $? != 0 ]]; then
    exit 1
fi
# quinto e sesto
./client -l "/tmp/chatty_socket" -k quo -S "ciao a tutti":  -S "ciao da quo":minni
if [[ $? != 0 ]]; then
    exit 1
fi
# settimo ed ottavo
./client -l "/tmp/chatty_socket" -k qua -S "ciao a tutti":  -S "ciao da qua":minni -p
if [[ $? != 0 ]]; then
    exit 1
fi

wait $pid
if [[ $? != 0 ]]; then
    echo "ESCO8"
    exit 1
fi

# messaggio di errore che mi aspetto
OP_NICK_ALREADY=26

# provo a ri-registrare pippo
./client -l "/tmp/chatty_socket" -c pippo
e=$?
if [[ $((256-e)) != $OP_NICK_ALREADY ]]; then
    echo "Errore non corrispondente $e"
    exit 1
fi

# deregistro pippo
./client -l "/tmp/chatty_socket" -k pippo -C pippo
if [[ $? != 0 ]]; then
    exit 1
fi
# deregistro pluto
./client -l "/tmp/chatty_socket" -k pluto -C pluto
if [[ $? != 0 ]]; then
    exit 1
fi

# registro pippo
./client -l "/tmp/chatty_socket" -c pippo
if [[ $? != 0 ]]; then
    exit 1
fi
# registro pluto
./client -l "/tmp/chatty_socket" -c pluto
if [[ $? != 0 ]]; then
    exit 1
fi

# pippo e pluto si scambiano files
./client -l "/tmp/chatty_socket" -k pippo -S "Ti mando un file":pluto -s ./client:pluto
if [[ $? != 0 ]]; then
    exit 1
fi
./client -l "/tmp/chatty_socket" -k pluto -S "Ti mando un file":pippo -s ./server_chatty.out:pippo -s ./client.c:pippo
if [[ $? != 0 ]]; then
    exit 1
fi

# controllo che i file siano arrivati al server e che siano corretti
md51=$(md5sum ./client | cut -d " " -f 1)
md52=$(md5sum ./server_chatty.out | cut -d " " -f 1)
md53=$(md5sum ./client.c | cut -d " " -f 1)
md5client=$(md5sum "/tmp/chatty"/client | cut -d " " -f 1)
md5chatty=$(md5sum "/tmp/chatty"/server_chatty.out | cut -d " " -f 1)
md5lib=$(md5sum "/tmp/chatty"/client.c | cut -d " " -f 1)

if [[ $md5client != $md51 ]]; then
    echo "./client e "/tmp/chatty"/client differiscono!"
    exit 1
fi
if [[ $md5chatty != $md52 ]]; then
    echo "./chatty e "/tmp/chatty"/chatty differiscono!"
    exit 1
fi
if [[ $md5lib != $md53 ]]; then
    echo "./libchatty.a e "/tmp/chatty"/libchatty.a differiscono!"
    exit 1
fi

echo "Test OK!"
exit 0
